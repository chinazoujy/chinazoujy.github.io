---
layout: post
title: "SQL inject attack"
data: 2014-12-9
categories: web
tag: web security
---

1. web 代理：Paros Proxy, WebScarab, Burp Suite

2. 用户请求触发数据库错误时的场景：
	1. 将SQL错误显示在页面上，它对WEB浏览器用户可见
	2. 将SQL错误隐藏在WEB页面的源代码中以便于调试
	3. 检测到错误时跳转到另一个页面
	4. 返回HTTP错误代码500（内部服务器错误）或HTTP重定向代码302
	5. 应用适当地处理错误但不显示结果，可能会显示一个通用的错误页面。

3. 时间延迟： 
	- MS ： `waitfor delay '0:0:5'`
	- MySQL： `BENCHMARK（100000000， ENCODE('hello','mom')）`
	- ORACLE PL/SQL：
{% highlight  ruby %}
BEGIN
DBMS_LOCK.SLEEP(5);
END;
# 不可直接注入到子查询中，oracle 不支持堆迭查询。只有管理员才能使用DBMS_LOCK包
{%  endhighlight %}
4. 寻找SQL注入：
   - 1）识别 Web 应用接收的数据输入， 2）修改输入值以包含危险的字符串 3）检测服务器返回的异常。
   - 使用 Web 代理角色扮演工具有助于绕过客户端限制，完全控制发送给服务器的请求。此外，它们还能提高服务器响应的可见度，
   - 提供更多检测到细小漏洞的机会（如果显示在 web 浏览器上，则很难被检测到）。
   - 包含数据库错误或http 错误代码的服务器响应通常能降低识别SQL注入漏洞的难度。不过SQL盲注是一种即使应用不返回错误也能利用漏洞的技术。

5. 确认SQL 注入：要想确认一个SQL注入漏洞并进一步加以利用，需要构造一条能注入SQL 代码的请求以便应用创建一条语法正确的SQL语句，之后由数据库服务器执行该语句且不返回任何错误。

   创建语法正确的语句时，可以终止它并注释剩下的查询。对于这种情况，通常可以毫无约束地连接任意SQL代码（假设后台数据库支持执行多条语句），进而提供执行攻击（如权限提升）的能力。
 
   有时，应用对注入操作没有回复任何可见的信息。这时可以通过向来自数据库的回复引入延迟来确认注入。应用服务器将等待数据库回复，我们则可以确认是否存在漏洞。对于这种情况，需要意识到网络和服务器工作负荷可能会对延迟造成轻微干扰。

6. 自动发现SQL 注入。
   - 寻找SQL 注入漏洞所涉及的操作可以被适度自动化。当需要测试大型的Web 站点时，自动技术非常有用，但需要意识到自动发现工具可能无法识别某些存在的漏洞，不能完全依赖自动化的工具

7. 引发SQL 注入漏洞的主要原因：
   - Web 应用未对用户提供的数据进行充分审查或未对输出进行编码是产生问题的主要原因，此外，攻击者还可以利用其他问题，比如糟糕的设计或不良的编码实践。如果缺少输入审查，那么所有这些问题都将可以被利用。

8. YASCA 是一个开源程序，用于寻找程序源代码中的安全漏洞和代码质量问题，支持的编程语言有PHP、Java 和 JavaScript（默认）。

 - Pixy 是一款免费的Java 程序，它能自动扫描PHP 4的源代码，目标是检测跨站脚本和SQL 注入漏洞。Pixy 通过分析源代码来寻找被感染的变量，之后再跟踪应用的数据流直到到达一个危险函数。它还能识别出变量何时不再受感染（例如，变量通过了一个审查程序）。Pixy 还能为受感染的变量绘制依赖图，该图对于理解漏洞报告很有帮助。通过依赖图，可以很容易跟踪到产生警告的源。但Pixy 无法识别mysql_db_query()、ociexecute()和odbc_exec() 函数中的SQL 注入漏洞。
 
 - Microsoft SQL 注入源代码分析器是一款静态代码分析工具，用于发现ASP 代码中的SQL 注入漏洞。该工具针对传统的ASP 代码而非.net 代码。此外，该工具只能理解使用VBScript 编写的传统的ASP代码，而无法分析使用由其他语言（如JAVASCRIPT）编写的服务器端代码。

9. -自动工具集成了三种不同的分析方法：基于字符串的模式匹配，词法标记匹配及借助抽象语法树AST和控制流图CFG的数据流分析。

  -有些自动工具使用正则表达式字符串匹配来识别渗入点（将受感染数据作为参数传递）和渗入源（应用中产生不可信数据的位置点）
  
  -词法分析接收一个由很多字符串构成的输入字符串，并将其经过处理后产生一个符号序列（称为词法标记）。可以使用工具对源文件进行预处理和分词操作，然后根据渗入点库来匹配这些词法标记

  -AST是一种表示简化的源代码语法结构的树，可以使用AST对源代码元素执行深层分析以帮助跟踪数据流并识别渗入点和渗入源
  
  -数据流分析是一种负责收集程序中有关数据使用、定义和依赖关系等信息的操作。数据流分析算法运行在AST产生的CFG 上

  -可以使用CFG来确定程序中将特定值分配给可传播变量的代码块。CFG使用图形标记来表示程序执行过程中可能遍历到的所有路径。

10. 识别数据库
     - ASP和.net 通常使用 Microsoft SQL Server 作为后台数据库，而PHP 应用则很可能使用 MYSQL。如果应用是用JAVA 编写的，那么使用的可能是ORACLE或者MYSQL， 此外，底层操作系统也可以提供一些线索：安装IIS 作为服务器平台标志着应用是基于WINDOWS 的架构，后台服务器很可能是SQL SERVER。而运行APACHE 和PHP 的LINUX 服务器很可能使用的是开源数据库。比如MYSQL。识别数据库的最好方法在很大程度上取决于是否处于盲态。如果应用返回（至少在某种程度上）查询结果和（或）DBMS错误消息（例如，非盲态），那么跟踪会相当简单，因为可以很容易通过产生的输出结果来提供关于底层技术的信息。但如果处于盲态，无法让应用返回DBMS 消息，那么就需要改变方法，尝试注入多种著名的、只针对特定技术才能执行的查询。通过判断这些查询中哪一条被成功执行，来获取目前所面对的DBMS 的精确信息。

11. 非盲跟踪
 - www.ora-code.com :提供了一个完整的ORACLE错误消息库

12. 获取数据库版本标志信息。
 - SQL SERVER： SELECT @@version
 - MySQL：	select version()  ;  
   		 select @@version
 - Oracle: 	select banner from v$version;
   		select banner from v$version where rownum=1

13. 从字符串推断DBMS 版本
 - SQL SERVER： select ‘some’+‘string’
 - MySQL:	select 'some'+'string'
   		select concat('some', 'string')
 - Oracle:	select 'some' || 'string'
   		select concat('some', 'string')

14. 从数字函数推断DBMS 版本
 - SQL SERVER： @@pack_received
       		@@rowcount
 - MySQL：	connection_id()
   		last_insert_id()
		row_count()
 - Oracle	BITAND(1,1)

15. 识别MYSQL 的小技巧
 - select 1 /*!40119 + 1 */
 该查询将返回下列结果：
  - 2 （如果MYSQL 版本为4.01.19 或更高版本）
  - 1 （其他情况）

16. union 运算符运行的要求：
    - 两个查询返回的列数必须相同
    - 两个select 语句返回的数据所对应的列必须类型相同（或至少是兼容的）

17. order by 
    - 可以通过增大order by 子句中代表列的数字来识别查询中的列数。如果在使用order by n 时收到第一个错误，则意味着查询中包含n-1列

18. union 与 order by 比较
    order by 优于union
    - union 的查找是n 次查找，order by 用二分查找是 log(n)，效率更优。
    - order by 留下的痕迹更小，通常在数据库日志中只留下很少的错误

19. 在使用union 做内联查询时候，为阻止查询返回结果中的第一行，需要在注入union查询之前添加一个
    使where 子句永远为假的条件。

20. 条件语句
    - 基于时间。
      SQL SERVER： 执行查询的用户是否为系统管理员账户（sa）
		   IF(system_user = ‘sa’) WAITFOR DELAY ‘0:0:5’ -- 
		   得到数据库的版本号,判断是否是2005的版本：
			IF (substring(（select @@version）, 25, 1) = 5) WAITFOR DELAY '0:0:5' -- 
      ORACLE: 可以通过向一个死的IP地址发送一个HTTP 请求来实现相同的效果。如果指定了一个不存在侦听者的IP的地址，那么下列查询将一直等待链接直到超时。
      	      select utl_http.request('http://10.0.0.1') from dual;
	      select HTTPURITYPE('http://10.0.0.1').getclob() from dual;
      基于时间的方法不适合提取多位信息。假设每一位为1或0的概论相同，我们使用5秒作为WAITFOR 
      的参数，那么每个查询将平均花费2.5秒来返回（加上了附加的网络延迟），这将导致该过程费力而缓慢。

    - 基于错误：速度快，缺点是会触发很多可能永远都不需要的错误
      - is_srvrolemember(‘sysadmin’) 返回3个值。“1”-》如果用户属于指定的组。
					"0" -> 如果用户不属于指定的组
					‘NULL’ -> 如果指定的组不存在
      - CASE 语句： CASE WHEN condition THEN action1 ELSE action2 END

    - 基于内容。速度快，不会触发错误
        使用“%2B” 将CASE WHEN condition THEN action1 ELSE action2 END 的结
        果连接起来，改变查询的内容。
21. SqlMap 的使用

22. 快速解决方案
    - 识别数据库。
      第一步始终会包含对远程数据库的精确跟踪
      最直接的方法是强迫远程应用返回一条能揭示DBMS技术的消息（通常是一条错误信息）
      如果那样做不可行，可注入一条只能工作在特定DBMS 上的查询
    - 使用union 语句提取数据
      要想成功地向现有查询添加数据，就必须保证它们的列数和数据类型均匹配
      所有数据类型均接收NULL 值， GROUP BY 是寻找要注入的准确列数的最快办法
      如果远程WEB 应用只返回第一行，那么可通过添加一个永假条件来移除原来的行，然后一次一行地提取想要的行
    - 使用条件语句
      使用条件语句，攻击者的每次请求可以提取一个数据位
      根据所提取位值的不同，可以选择引入延迟、产生错误或强迫应用返回一个不同的HTML 页面
      每种技术都有最适合使用的场景。基于延迟的技术速度虽慢但非常灵活，基于内容的技术相比基于错误的技术则会留下更少的痕迹。
    - 枚举数据库模式
      遵循一种分级的方法：首先枚举数据库，然后是每个数据库的表，之后是每个表的列，最后是每一列的数据
      如果远程数据库很大，则不需要提取整个数据库。先快速浏览一下表名通常就足以确定想要的数据的位置
    - 提升权限
      所有主流的DBMS 一直以来都深受权限提升漏洞之苦，正在攻击的DBMS 很可能未升级至最新的安全更新程序
      对于其他的情况，可以尝试暴力破解管理员账户，例如在SQL SERVER 上使用OPENROWSET
    - 窃取哈希口令
      如果拥有管理员权限。请不要错过获取哈希口令的机会，人们都倾向于重用口令，这些哈希可能是进入的机会
    - 带外通信
      如果无法使用前面的方法提取数据，可以尝试建立一种完全不同的通道
      可能的选项包括email（SMTP）、 HTTP、 DNS、 文件系统或针对特定数据库的链接
    - 自动利用SQL 注入
      大多数攻击都需要发送大量请求以达到目的
      一般都利用工具来实现

23. SQL 盲注
    - 无法使用详细数据库错误消息或带内数据链接的情况下，利用数据库查询的输入审查漏洞从数据库提取信息或提取与数据库查询相关信息的攻击技术。
    - 主要用于从数据库提取信息，但也可以用于获取正在注入SQL的查询的结构
    - 使用的三种的场景中：
      - 提交一个导致SQL 查询无效的利用时会返回一个通用的错误页面，而提交正确的SQL 时则会返回一个内容可被适度控制的页面。
      - 提交一个导致SQL 查询无效的利用时会返回一个通用的错误页面，而提交正确的SQL 时则会返回一个内容不可控的页面。当页面包含多个SQL 查询， 但只有第一个查询易收到攻击且不产生输出时会碰到这种情况。 
      - 提交受损或不正确的SQL 即不会产生错误页面，也不会以任何方式影响页面的输出。因为这种类型的SQL 盲注场景不返回错误，而基于时间的利用或产生带外副作用的利用则最有可能成功识别易受攻击的参数。
    - 推断技术，使用条件查询利用内容的差异。

24. Squeeza 自动SQL 盲注利用工具，ruby 编写

25. 寻找并确认SQL 盲注
    - 无效数据将返回一个通用错误页面而非详细错误，这时可通过包含副作用（比如时间延迟）来确认SQL 注入，还可以拆分，平衡参数，如果数字字段为5，则提交3+2或6-1； 如果字符串参数中包含“MadBod”,则提交 'Mad'||'Bod'
    - 请思考漏洞的属性：能否强制产生错误以及能否控制无错误页面的内容？
    - 可通过在SQL 中提问某一位是1 还是0 来推断单个信息位，有很多推断技术可用于实现该目标。
    使用基于时间的技术
    - 可使用逐位方法或二进制搜索方法提取数据并利用延迟表示数据的值，可使用明确的SLEEP（）类型函数或运行时间很长的查询来引入延迟
    - 通常在SQL SERVER 上以时间作为推断方法，不过在ORACLE 和MYSQL 上则不太可靠，该机制很可能会失效
    - 使用时间作为推断方法在本质上是不可靠的，但却可以通过增加超时或借助其他技巧来进行改进
    使用基于响应的技术
    - 可使用逐位方法或二进制搜索方法提取数据并利用响应内容表示数据的值。一般来说，现有的查询中都包含一条插入子句，它能够根据推断的值来保持查询不变或返回空结果。
    - 基于响应的技术可成功用于多种多样的数据库
    - 某些情况下，一个请求可返回多个信息位。
    使用非主流通道
    - 带外通信的优点：可以以块而非位方式来提取数据，并且速度上有明显改进。
    - 最常用的通道是DNS， 攻击者说服数据库执行一个名称查找,该查找包含一个由攻击者控制的域名并在域名前添加一些要提取的数据，其他通道包括HTTP 和SMTP。
    
26. 使用混合攻击
    - 修改捕获的数据
    - 创建跨站脚本
